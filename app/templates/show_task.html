{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
    <form id="editTask" method="post">
        {{ form.hidden_tag() }}
        <a class="btn btn-info" href="{{ url_for('tasks') }}">Back</a>
        <div>
           <div style="float: left;">
               <p>
                   {{ form.title.label }}<br>
                   {{ form.title(size=64) }}
                   {% for error in form.title.errors %}
                       <span style="color: red;">[{{ error }}]</span>
                   {% endfor %}
               </p>
               <p>
                   {{ form.status.label }}<br>
                   {{ form.status(size=16, readonly=True) }}
                   {% for error in form.status.errors %}
                       <span style="color: red;">[{{ error }}]</span>
                   {% endfor %}
               </p>
               <p>
                   {{ form.description.label }}<br>
                   {{ form.description(rows=4, cols=65) }}<br>
                   {% for error in form.description.errors %}
                      <span style="color: red;">[{{ error }}]</span>
                   {% endfor %}
               </p>
           </div>
           <div style="float: right;">
               <p>
                   {{ form.user.label }}<br>
                   {% if task.id_users %}
                       <img src="/static/images/default.svg" width="20" height="20">
                   {% endif %}
                   {{ form.user(size=24) }}<br>
                   {% if task.id_users %}
                       {% if task.id_users == current_user.id %}
                           <a id="link1" href="#">Assign partner</a>
                       {% elif task.id_users != current_user.id %}
                           <a id="link2" href="#">Assign me</a>
                       {% endif %}
                   {% else %}
                        <a id="link3" href="#">Assign me</a>|<a id="link4" href="#">Assign partner</a>
                   {% endif %}
                   {% for error in form.user.errors %}
                       <span style="color: red;">[{{ error }}]</span>
                   {% endfor %}
               </p>
               <p>
                   {{ form.priority.label }}<br>
                   <select name="priority">
                   {% for priority in priorities %}
                       {% if priority.id == task.id_priority %}
                           <option selected value="{{ priority.id }}">{{ priority.name }}</option>
                       {% else %}
                           <option value="{{ priority.id }}">{{ priority.name }}</option>
                       {% endif %}
                   {% endfor %}
                   </select>
                   {% for error in form.priority.errors %}
                       <span style="color: red;">[{{ error }}]</span>
                   {% endfor %}
               </p>
               <p>
                   {{ form.complexity.label }}<br>
                   <select name="complexity">
                       {% for complexity in complexities %}
                           {% if complexity.id == task.id_complexity %}
                               <option selected value="{{ complexity.id }}">{{ complexity.name }}</option>
                           {% else %}
                               <option value="{{ complexity.id }}">{{ complexity.name }}</option>
                           {% endif %}
                      {% endfor %}
                   </select>
                   {% for error in form.complexity.errors %}
                       <span style="color: red;">[{{ error }}]</span>
                   {% endfor %}
               </p>
               <p>
                   {{ form.deadline.label }}<br>
                   {{ form.deadline(size=24) }}
                   {% for error in form.deadline.errors %}
                       <span style="color: red;">[{{ error }}]</span>
                   {% endfor %}
               </p>
           </div>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        //функция для обновления задачи
        function doPostUpdateTask(newValue, oldValue) {

            if (newValue !== oldValue) {

                $.post('/edit_task/{{ task.id }}', $('#editTask').serialize()
                ).done(function(response) {

                    const elem = '<div class="alert alert-info" role="alert">Task ' + $('#title').val() + ' success update</div>';
                    $('#editTask').before(elem);
                    setTimeout(
                        function() {

                            $('.alert-info').remove();

                        },
                    3000);

                }).fail(function() {
                    console.log("fail");
                });

            }

        }

        $("#link1").click(
            function() {

                const oldUser = $('#user').val();
                const newUser = "{{ current_user.get_partner(current_user) }}";
                $('#user').val(newUser);
                doPostUpdateTask(newUser, oldUser);
                setTimeout(
                    function() {

                        location.reload();

                    },
                1000);

            }
        );
        $("#link2").click(
            function() {

                const oldUser = $('#user').val();
                const newUser = "{{ current_user.get_user(current_user.id) }}";
                $('#user').val(newUser);
                doPostUpdateTask(newUser, oldUser);
                setTimeout(
                    function() {

                        location.reload();

                    },
                1000);

            }

        );
        $("#link3").click(
            function() {

                const oldUser = $('#user').val();
                const newUser = "{{ current_user.get_user(current_user.id) }}";
                $('#user').val(newUser);
                doPostUpdateTask(newUser, oldUser);
                setTimeout(
                    function() {

                        location.reload();

                    },
                1000);

            }
        );
        $("#link4").click(
            function() {

                const oldUser = $('#user').val();
                const newUser = "{{ current_user.get_partner(current_user) }}";
                $('#user').val(newUser);
                doPostUpdateTask(newUser, oldUser);
                setTimeout(
                    function() {

                        location.reload();

                    },
                1000);

            }
        );
        //обновление заголовка
        let oldTitle = $('#title').val();
        $("#title").mouseleave(
            function() {

                doPostUpdateTask($(this).val(), oldTitle);
                oldTitle = $(this).val();

            }
        );
        //обновление описания
        let oldDescr = $('#description').val();
        $("#description").mouseleave(
            function() {

                doPostUpdateTask($(this).val(), oldDescr);
                oldDescr = $(this).val();

            }
        );
        //обновление приоритета
        let oldPriority = $('select[name=priority]').val();
        $('select[name=priority]').change(
            function() {

                doPostUpdateTask($(this).val(), oldPriority);
                oldPriority = $(this).val();

            }
        );
        //обновление сложности
        let oldComplexity = $('select[name=complexity]').val();
        $('select[name=complexity]').change(
            function() {

                doPostUpdateTask($(this).val(), oldComplexity);
                oldComplexity = $(this).val();

            }
        );
        //обновление деадлайна
        let oldDeadline = $('#deadline').val();
        $('#deadline').change(
            function() {

                doPostUpdateTask($(this).val(), oldDeadline);
                oldDeadline = $(this).val();

            }
        );
    </script>
{% endblock %}